name: iOS TestFlight (MAUI) - iOS only

on:
  workflow_dispatch:

concurrency:
  group: ios-testflight-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  DOTNET_VERSION: 8.0.415
  XCODE_VERSION: "16.1"

jobs:
  build-and-upload:
    runs-on: macos-14

    steps:
      # 1) Repos
      - name: Checkout (CI repo)
        uses: actions/checkout@v4

      - name: Checkout private source
        uses: actions/checkout@v4
        with:
          repository: Salvacuentacuentos/Eraseunaapp
          path: source/repos
          ssh-key: ${{ secrets.PRIVATE_REPO_DEPLOY_KEY }}

      # 2) Toolchain
      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Point .NET to selected Xcode
        shell: bash
        run: |
          set -euo pipefail
          XCODE_DEV="$(xcode-select -p)"
          XCODE_APP="$(dirname "$(dirname "$XCODE_DEV")")"
          echo "DEVELOPER_DIR=$XCODE_DEV"     >> "$GITHUB_ENV"
          echo "MD_APPLE_SDK_ROOT=$XCODE_APP" >> "$GITHUB_ENV"
          xcodebuild -version

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.sln', '**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # 3) Localizar proyecto y fijar SDK
      - name: Locate project (auto)
        id: proj
        shell: bash
        run: |
          set -euo pipefail
          CS=$(find source -maxdepth 6 -type f -name "Eraseunaapp.csproj" -print -quit)
          [ -n "$CS" ] || { echo "No se encontró Eraseunaapp.csproj"; exit 1; }
          DIR=$(dirname "$CS")
          echo "csproj=$CS"  >> $GITHUB_OUTPUT
          echo "srcdir=$DIR" >> $GITHUB_OUTPUT
          echo "Proyecto: $CS"; echo "Carpeta: $DIR"

      - name: Pin .NET 8 SDK (global.json)
        working-directory: ${{ steps.proj.outputs.srcdir }}
        shell: bash
        run: |
          cat > global.json <<'JSON'
          { "sdk": { "version": "8.0.415", "rollForward": "disable" } }
          JSON
          dotnet --version

      - name: Install MAUI workloads (iOS)
        working-directory: ${{ steps.proj.outputs.srcdir }}
        shell: bash
        run: |
          set -euo pipefail
          dotnet workload install maui maui-ios --source https://api.nuget.org/v3/index.json
          dotnet workload restore

      # 4) Catálogo AppIcon en Resources/Assets.xcassets (iPad 152 + ios-marketing 1024)
      - name: Synthesize AppIcon (Resources/Assets.xcassets)
        working-directory: ${{ steps.proj.outputs.srcdir }}
        shell: bash
        run: |
          set -euo pipefail
          ICON=Resources/AppIcon/appicon.png
          [ -s "$ICON" ] || { echo "❌ Falta $ICON (1024x1024 PNG)"; exit 1; }
          rm -rf Resources/Assets.xcassets Platforms/iOS/Assets.xcassets || true

          XC="Resources/Assets.xcassets"
          SET="$XC/AppIcon.appiconset"
          mkdir -p "$SET"
          printf '{ "info": { "version": 1, "author": "xcode" } }\n' > "$XC/Contents.json"

          gen(){ sips -s format png "$ICON" --resampleWidth "$1" --out "$SET/$2" >/dev/null; }
          # iPhone
          gen 40  icon-20@2x.png;  gen 60  icon-20@3x.png
          gen 58  icon-29@2x.png;  gen 87  icon-29@3x.png
          gen 80  icon-40@2x.png;  gen 120 icon-40@3x.png
          gen 120 icon-60@2x.png;  gen 180 icon-60@3x.png
          # iPad (incluye 152)
          gen 20  icon-20-ipad.png;   gen 40  icon-20-ipad@2x.png
          gen 29  icon-29-ipad.png;   gen 58  icon-29-ipad@2x.png
          gen 40  icon-40-ipad.png;   gen 80  icon-40-ipad@2x.png
          gen 76  icon-76.png;        gen 152 icon-76@2x.png
          gen 167 icon-83.5@2x.png
          # Marketing
          gen 1024 icon-marketing.png

          cat > "$SET/Contents.json" <<'JSON'
          {
            "images": [
              {"idiom":"iphone","size":"20x20","scale":"2x","filename":"icon-20@2x.png"},
              {"idiom":"iphone","size":"20x20","scale":"3x","filename":"icon-20@3x.png"},
              {"idiom":"iphone","size":"29x29","scale":"2x","filename":"icon-29@2x.png"},
              {"idiom":"iphone","size":"29x29","scale":"3x","filename":"icon-29@3x.png"},
              {"idiom":"iphone","size":"40x40","scale":"2x","filename":"icon-40@2x.png"},
              {"idiom":"iphone","size":"40x40","scale":"3x","filename":"icon-40@3x.png"},
              {"idiom":"iphone","size":"60x60","scale":"2x","filename":"icon-60@2x.png"},
              {"idiom":"iphone","size":"60x60","scale":"3x","filename":"icon-60@3x.png"},

              {"idiom":"ipad","size":"20x20","scale":"1x","filename":"icon-20-ipad.png"},
              {"idiom":"ipad","size":"20x20","scale":"2x","filename":"icon-20-ipad@2x.png"},
              {"idiom":"ipad","size":"29x29","scale":"1x","filename":"icon-29-ipad.png"},
              {"idiom":"ipad","size":"29x29","scale":"2x","filename":"icon-29-ipad@2x.png"},
              {"idiom":"ipad","size":"40x40","scale":"1x","filename":"icon-40-ipad.png"},
              {"idiom":"ipad","size":"40x40","scale":"2x","filename":"icon-40-ipad@2x.png"},
              {"idiom":"ipad","size":"76x76","scale":"1x","filename":"icon-76.png"},
              {"idiom":"ipad","size":"76x76","scale":"2x","filename":"icon-76@2x.png"},
              {"idiom":"ipad","size":"83.5x83.5","scale":"2x","filename":"icon-83.5@2x.png"},

              {"idiom":"ios-marketing","size":"1024x1024","scale":"1x","filename":"icon-marketing.png"}
            ],
            "info":{"version":1,"author":"xcode"}
          }
          JSON
          ls -la "$SET"

      # 5) Neutraliza <MauiIcon> y CFBundleIconName antiguos en el runner
      - name: Disable MAUI auto icon generation (edit csproj in runner)
        working-directory: ${{ steps.proj.outputs.srcdir }}
        shell: bash
        run: |
          set -euo pipefail
          CS="${{ steps.proj.outputs.csproj }}"; BN="${CS##*/}"
          cp "$BN" "$BN.bak"
          sed -E '/<MauiIcon\b[^>]*>/,/<\/MauiIcon>/d' "$BN.bak" > "$BN" || true
          sed -E -i '' '/<CFBundleIconName>.*<\/CFBundleIconName>/d' "$BN" || true

      # 6) Firma (keychain + p12 + provisioning)
      - name: Create & unlock keychain
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        shell: bash
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain

      - name: Import .p12 into keychain
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          IOS_DISTRIBUTION_P12_BASE64: ${{ secrets.IOS_DISTRIBUTION_P12_BASE64 }}
          IOS_DISTRIBUTION_P12_PASSWORD: ${{ secrets.IOS_DISTRIBUTION_P12_PASSWORD }}
        shell: bash
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          P12="$RUNNER_TEMP/dist.p12"
          printf %s "$IOS_DISTRIBUTION_P12_BASE64" | base64 --decode > "$P12"
          security import "$P12" -k "$KEYCHAIN_PATH" -P "$IOS_DISTRIBUTION_P12_PASSWORD" -A -f pkcs12 -T /usr/bin/codesign -T /usr/bin/security || {
            openssl pkcs12 -in "$P12" -passin pass:"$IOS_DISTRIBUTION_P12_PASSWORD" -nodes -out "$RUNNER_TEMP/tmp.pem"
            openssl pkcs12 -export -in "$RUNNER_TEMP/tmp.pem" -passout pass:"$IOS_DISTRIBUTION_P12_PASSWORD" -out "$RUNNER_TEMP/dist-legacy.p12"
            security import "$RUNNER_TEMP/dist-legacy.p12" -k "$KEYCHAIN_PATH" -P "$IOS_DISTRIBUTION_P12_PASSWORD" -A -f pkcs12 -T /usr/bin/codesign -T /usr/bin/security
          }
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          CERT_NAME="$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | sed -n 's/.*"\(.*\)".*/\1/p' | head -n1)"
          echo "CERT_NAME=$CERT_NAME" >> "$GITHUB_ENV"

      - name: Install provisioning profile (App Store)
        env:
          IOS_APPSTORE_PROFILE_B64: ${{ secrets.IOS_APPSTORE_PROFILE_B64 }}
        shell: bash
        run: |
          set -euo pipefail
          RAW="$RUNNER_TEMP/app.mobileprovision"
          printf %s "$IOS_APPSTORE_PROFILE_B64" | base64 --decode > "$RAW"
          security cms -D -i "$RAW" > "$RUNNER_TEMP/profile.plist"
          PP_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' "$RUNNER_TEMP/profile.plist")
          echo "PP_UUID=$PP_UUID" >> "$GITHUB_ENV"
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$RAW" "$HOME/Library/MobileDevice/Provisioning Profiles/$PP_UUID.mobileprovision"

      # 7) Restore (.NET 8)
      - name: Restore
        working-directory: ${{ steps.proj.outputs.srcdir }}
        shell: bash
        run: |
          set -euo pipefail
          dotnet restore -p:TreatWarningsAsErrors=false -p:NoWarn=NU1605

      # 8) Publicar (firma) – forzamos CFBundleIconName=AppIcon
      - name: Publish (.xcarchive + .ipa)
        working-directory: ${{ steps.proj.outputs.srcdir }}
        shell: bash
        run: |
          set -euo pipefail
          PROJ="${{ steps.proj.outputs.csproj }}"; NAME="${PROJ##*/}"
          echo "Publicando: $NAME"
          dotnet workload restore
          dotnet publish "$NAME" \
            -c Release -f net8.0-ios \
            -p:RuntimeIdentifier=ios-arm64 \
            -p:ArchiveOnBuild=true \
            -p:BuildIpa=true \
            -p:PublishTrimmed=true \
            -p:CFBundleIconName=AppIcon \
            -p:CodesignKey="${CERT_NAME}" \
            -p:CodesignKeychain="${KEYCHAIN_PATH}" \
            -p:ProvisioningProfileUuid="${PP_UUID}" \
            -p:TreatWarningsAsErrors=false -p:NoWarn=NU1605
          echo "Publish OK"

      # 9) Localizar IPA original
      - name: Find IPA
        id: findipa
        shell: bash
        run: |
          set -euo pipefail
          ROOT="${{ steps.proj.outputs.srcdir }}/bin/Release/net8.0-ios/ios-arm64"
          IPA="$(find "$ROOT/publish" -type f -name '*.ipa' -print -quit || true)"
          if [ -z "$IPA" ]; then IPA="$(find "$ROOT" -type f -name '*.ipa' -print -quit || true)"; fi
          [ -n "$IPA" ] && echo "ipa=$IPA" >> $GITHUB_OUTPUT || { echo "No IPA found"; exit 1; }
          echo "IPA => $IPA"

      # 10) PARCHE: compilar Assets.car FUERA, copiar y re-firmar con --deep (incluye --output-partial-info-plist)
      - name: Patch IPA with asset catalog + resign (safe)
        id: patchipa
        shell: bash
        run: |
          set -euo pipefail
          IPA_IN="${{ steps.findipa.outputs.ipa }}"
          WORK_DIR="$(mktemp -d)"
          unzip -q "$IPA_IN" -d "$WORK_DIR"
          APP_PATH="$(ls "$WORK_DIR"/Payload/*.app)"
          echo "App => $APP_PATH"

          ASSETS_DIR="${{ steps.proj.outputs.srcdir }}/Resources/Assets.xcassets"
          [ -d "$ASSETS_DIR" ] || { echo "❌ No existe $ASSETS_DIR"; exit 1; }

          OUT_DIR="$(mktemp -d)"
          xcrun actool "$ASSETS_DIR" \
            --compile "$OUT_DIR" \
            --platform iphoneos \
            --target-device iphone \
            --target-device ipad \
            --minimum-deployment-target 12.0 \
            --app-icon AppIcon \
            --output-partial-info-plist "$OUT_DIR/partial.plist"

           - name: Patch IPA with asset catalog + resign (safe, ditto)
           id: patchipa
           shell: bash
           run: |
          set -euo pipefail
          IPA_IN="${{ steps.findipa.outputs.ipa }}"
          WORK_DIR="$(mktemp -d)"
          unzip -q "$IPA_IN" -d "$WORK_DIR"
          APP_PATH="$(ls "$WORK_DIR"/Payload/*.app)"
          echo "App => $APP_PATH"

          ASSETS_DIR="${{ steps.proj.outputs.srcdir }}/Resources/Assets.xcassets"
          [ -d "$ASSETS_DIR" ] || { echo "❌ No existe $ASSETS_DIR"; exit 1; }

          OUT_DIR="$(mktemp -d)"
          xcrun actool "$ASSETS_DIR" \
            --compile "$OUT_DIR" \
            --platform iphoneos \
            --target-device iphone \
            --target-device ipad \
            --minimum-deployment-target 12.0 \
            --app-icon AppIcon \
            --output-partial-info-plist "$OUT_DIR/partial.plist"

          [ -s "$OUT_DIR/Assets.car" ] || { echo "❌ actool no generó Assets.car"; ls -la "$OUT_DIR"; cat "$OUT_DIR/partial.plist" || true; exit 1; }
          cp -f "$OUT_DIR/Assets.car" "$APP_PATH/Assets.car"
          echo "✅ Copiado Assets.car a la app."

          ENT="$RUNNER_TEMP/ents.plist"; ENT_FLAG=""
          if codesign -d --entitlements :- "$APP_PATH" > "$ENT" 2>/dev/null; then
            ENT_FLAG="--entitlements $ENT"
          fi

          xcrun codesign --force --deep --keychain "${KEYCHAIN_PATH}" \
            --sign "${CERT_NAME}" --options runtime $ENT_FLAG "$APP_PATH"

          # Empaquetar IPA con 'ditto' (evita 'name too long' de zip)
          NEWIPA="$RUNNER_TEMP/Eraseunaapp_resigned.ipa"
          xcrun ditto -c -k --sequesterRsrc --keepParent "$WORK_DIR/Payload" "$NEWIPA"
          echo "ipa=$NEWIPA" >> $GITHUB_OUTPUT
          echo "Patched IPA => $NEWIPA"


      # 11) Verificar que ahora existe Assets.car y contiene ios-marketing
      - name: Verify compiled asset catalog (ios-marketing)
        shell: bash
        run: |
          set -euo pipefail
          IPA="${{ steps.patchipa.outputs.ipa }}"
          APPDIR="$(mktemp -d)"
          unzip -q "$IPA" -d "$APPDIR"
          APP_PATH="$(ls "$APPDIR"/Payload/*.app)"
          CAR="$APP_PATH/Assets.car"
          [ -s "$CAR" ] || { echo "❌ No existe Assets.car en $APP_PATH"; ls -la "$APP_PATH"; exit 1; }
          echo "Assets.car => $CAR"
          xcrun assetutil --info "$CAR" | grep -i '"idiom" *: *"ios-marketing"' -A2 || { echo "❌ ios-marketing no encontrado en Assets.car"; exit 1; }
          echo "✅ ios-marketing presente en Assets.car"

      # 12) Inspección Info.plist
      - name: Inspect IPA bundle id & icon name
        shell: bash
        run: |
          set -euo pipefail
          IPA="${{ steps.patchipa.outputs.ipa }}"
          PLIST_XML="$(unzip -p "$IPA" Payload/*.app/Info.plist | plutil -convert xml1 -o - -)"
          echo "BundleId:  $(echo "$PLIST_XML" | /usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' /dev/stdin)"
          echo "IconName:  $(echo "$PLIST_XML" | /usr/libexec/PlistBuddy -c 'Print :CFBundleIconName' /dev/stdin)"

      # 13) Subida TestFlight (usa IPA parchada)
      - name: Upload to TestFlight
        env:
          APPSTORE_ISSUER_ID:   ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_KEY_ID:      ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_PRIVATE_KEY: ${{ secrets.APPSTORE_PRIVATE_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          IPA="${{ steps.patchipa.outputs.ipa }}"
          mkdir -p "$HOME/.appstoreconnect/private_keys"
          KEYFILE="$HOME/.appstoreconnect/private_keys/AuthKey_${APPSTORE_KEY_ID}.p8"
          CONTENT="${APPSTORE_PRIVATE_KEY}"
          if echo "$CONTENT" | grep -q "BEGIN PRIVATE KEY"; then
            printf '%b' "$CONTENT" > "$KEYFILE"
          else
            if printf '%s' "$CONTENT" | base64 -d > "$KEYFILE" 2>/dev/null; then :; else printf '%b' "$CONTENT" > "$KEYFILE"; fi
          fi
          chmod 600 "$KEYFILE"
          xcrun altool --upload-app -f "$IPA" -t ios \
            --apiKey "$APPSTORE_KEY_ID" --apiIssuer "$APPSTORE_ISSUER_ID" --verbose

      # 14) Artefactos (IPA final + logs)
      - name: Upload artifact (IPA)
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ${{ steps.patchipa.outputs.ipa }}

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-logs
          path: |
            $HOME/Library/Logs/DiagnosticReports/*
          if-no-files-found: ignore
