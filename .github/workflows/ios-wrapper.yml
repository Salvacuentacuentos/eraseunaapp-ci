name: iOS TestFlight (MAUI) ‚Äî iOS only + PreCheck icono

on:
  workflow_dispatch:

concurrency:
  group: ios-testflight-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  DOTNET_VERSION: 8.0.415
  XCODE_VERSION: "16.1"         # SDK iOS 18
  CONFIGURATION: Release
  RUNTIME_IDENTIFIER: ios-arm64

jobs:
  build-and-upload:
    runs-on: macos-14

    steps:
      # Repo CI (este)
      - name: Checkout (CI repo)
        uses: actions/checkout@v4

      # Repo privado con c√≥digo
      - name: Checkout private source
        uses: actions/checkout@v4
        with:
          repository: Salvacuentacuentos/Eraseunaapp
          path: source/repos
          ssh-key: ${{ secrets.PRIVATE_REPO_DEPLOY_KEY }}

      # Xcode + .NET
      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Detectar csproj host
      - name: Locate project (auto)
        id: proj
        run: |
          set -euo pipefail
          CS=$(find source -maxdepth 6 -type f -name "Eraseunaapp.csproj" -print -quit)
          [ -n "$CS" ] || { echo "::error::No se encontr√≥ Eraseunaapp.csproj"; exit 1; }
          DIR=$(dirname "$CS")
          echo "csproj=$CS"   >> $GITHUB_OUTPUT
          echo "srcdir=$DIR"  >> $GITHUB_OUTPUT
          echo "Proyecto: $CS"

      # Fijar SDK 8.0.415
      - name: Pin .NET 8 SDK (global.json)
        working-directory: ${{ steps.proj.outputs.srcdir }}
        run: |
          cat > global.json <<'JSON'
          { "sdk": { "version": "8.0.415", "rollForward": "disable" } }
          JSON
          dotnet --info | sed -n '1,40p'

      # Workloads
      - name: Install MAUI workloads (iOS)
        run: |
          set -euo pipefail
          dotnet workload install maui maui-ios --source https://api.nuget.org/v3/index.json
          dotnet workload restore

      # ‚ö†Ô∏è VERIFICACI√ìN ICONO 1024 y carpeta exacta 'Resources/AppIcon/appicon.png'
      - name: Verify App Icon 1024 (AppIcon/appicon.png)
        working-directory: ${{ steps.proj.outputs.srcdir }}
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -d "Resources/AppIcon" ]; then
            ALT=$(find Resources -maxdepth 1 -type d -iname 'app*icon*' -print | head -n1 || true)
            echo "::error::No existe la carpeta 'Resources/AppIcon'."
            [ -n "$ALT" ] && echo "::error::¬øQuiz√° quer√≠as '$ALT'? Ren√≥mbrala exactamente a 'AppIcon'."
            exit 1
          fi
          ICON="Resources/AppIcon/appicon.png"
          [ -f "$ICON" ] || { echo "::error::Falta $ICON"; exit 1; }
          W=$(sips -g pixelWidth  "$ICON" | awk '/pixelWidth/{print $2}')
          H=$(sips -g pixelHeight "$ICON" | awk '/pixelHeight/{print $2}')
          echo "Icon size => ${W}x${H}"
          if [ "$W" != "1024" ] || [ "$H" != "1024" ]; then
            echo "::error::El icono debe ser exactamente 1024x1024. Actual: ${W}x${H}"
            exit 1
          fi
          echo "‚úÖ Icono OK (1024x1024) en Resources/AppIcon/appicon.png"

      # Keychain + certificado
      - name: Create & unlock keychain
        env: { KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }} }
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

      - name: Import .p12 (robusto)
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          IOS_DISTRIBUTION_P12_BASE64: ${{ secrets.IOS_DISTRIBUTION_P12_BASE64 }}
          IOS_DISTRIBUTION_P12_PASSWORD: ${{ secrets.IOS_DISTRIBUTION_P12_PASSWORD }}
        run: |
          set -euo pipefail
          KC="$KEYCHAIN_PATH"
          P12="$RUNNER_TEMP/dist.p12"
          printf %s "$IOS_DISTRIBUTION_P12_BASE64" | base64 --decode > "$P12"
          # Validar pass
          openssl pkcs12 -in "$P12" -passin pass:"$IOS_DISTRIBUTION_P12_PASSWORD" -info -nokeys >/dev/null 2>&1 || {
            echo "::error::Contrase√±a del .p12 incorrecta"; exit 1; }
          # Import
          if ! security import "$P12" -k "$KC" -P "$IOS_DISTRIBUTION_P12_PASSWORD" -A -f pkcs12 \
               -T /usr/bin/codesign -T /usr/bin/security; then
            echo "Reempaquetando p12 a legacy‚Ä¶"
            openssl pkcs12 -in "$P12" -passin pass:"$IOS_DISTRIBUTION_P12_PASSWORD" -nodes -out "$RUNNER_TEMP/tmp.pem"
            openssl pkcs12 -export -in "$RUNNER_TEMP/tmp.pem" -out "$RUNNER_TEMP/dist-legacy.p12" -passout pass:"$IOS_DISTRIBUTION_P12_PASSWORD"
            security import "$RUNNER_TEMP/dist-legacy.p12" -k "$KC" -P "$IOS_DISTRIBUTION_P12_PASSWORD" -A -f pkcs12 \
              -T /usr/bin/codesign -T /usr/bin/security
          fi
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KC"
          ID="$(security find-identity -v -p codesigning "$KC" | grep -E 'Apple Distribution:' | head -n1 | sed -E 's/.*"(.+)".*/\1/')"
          TEAMID="$(echo "$ID" | sed -n 's/.*(\(.*\)).*/\1/p')"
          echo "CODESIGN_IDENTITY=$ID" >> "$GITHUB_ENV"
          echo "TEAMID=$TEAMID" >> "$GITHUB_ENV"
          echo "üîê Cert: $ID | Team: $TEAMID"

      # Provisioning profile
      - name: Install provisioning profile (App Store)
        env: { IOS_APPSTORE_PROFILE_B64: ${{ secrets.IOS_APPSTORE_PROFILE_B64 }} }
        run: |
          set -euo pipefail
          PP_RAW="$RUNNER_TEMP/profile.mobileprovision"
          printf %s "$IOS_APPSTORE_PROFILE_B64" | base64 --decode > "$PP_RAW"
          security cms -D -i "$PP_RAW" > "$RUNNER_TEMP/profile.plist"
          PP_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' "$RUNNER_TEMP/profile.plist")
          PP_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' "$RUNNER_TEMP/profile.plist")
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PP_RAW" "$HOME/Library/MobileDevice/Provisioning Profiles/$PP_UUID.mobileprovision"
          echo "PROVISIONING_UUID=$PP_UUID" >> "$GITHUB_ENV"
          echo "PROVISIONING_NAME=$PP_NAME" >> "$GITHUB_ENV"
          echo "üìÑ Perfil: $PP_NAME ($PP_UUID)"

      # Publicar y generar IPA
      - name: Publish (.xcarchive + .ipa)
        working-directory: ${{ steps.proj.outputs.srcdir }}
        run: |
          set -euo pipefail
          # Asegura CFBundleIconName=AppIcon y un build number creciente
          BUILD_NO=$(date -u +%Y%m%d%H%M%S)
          dotnet publish "$(basename "${{ steps.proj.outputs.csproj }}")" \
            -c ${{ env.CONFIGURATION }} -f net8.0-ios -p:RuntimeIdentifier=${{ env.RUNTIME_IDENTIFIER }} \
            -p:ArchiveOnBuild=true -p:BuildIpa=true \
            -p:CFBundleIconName=AppIcon \
            -p:ApplicationVersion=$BUILD_NO -p:CFBundleVersion=$BUILD_NO \
            -p:CodesignKey="${{ env.CODESIGN_IDENTITY }}" -p:CodesignTeamId="${{ env.TEAMID }}" \
            -p:ProvisioningProfileUuid="${{ env.PROVISIONING_UUID }}" \
            -p:TreatWarningsAsErrors=false -p:NoWarn=NU1605

      - name: Find IPA & inspect Info.plist
        id: ipa
        working-directory: ${{ steps.proj.outputs.srcdir }}
        run: |
          set -euo pipefail
          IPA=$(find "bin/${{ env.CONFIGURATION }}/net8.0-ios/${{ env.RUNTIME_IDENTIFIER }}" -name "*.ipa" -print -quit)
          [ -n "$IPA" ] || { echo "::error::No se gener√≥ .ipa"; exit 1; }
          echo "ipa=$IPA" >> $GITHUB_OUTPUT
          # Mostrar CFBundleIdentifier y CFBundleIconName dentro de la IPA
          PLIST_XML="$(unzip -p "$IPA" Payload/*.app/Info.plist | plutil -convert xml1 -o - -)"
          BUNDLE_ID=$(echo "$PLIST_XML" | /usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' /dev/stdin)
          ICON_NAME=$(echo "$PLIST_XML" | /usr/libexec/PlistBuddy -c 'Print :CFBundleIconName' /dev/stdin || true)
          echo "BundleId: $BUNDLE_ID"
          echo "CFBundleIconName: ${ICON_NAME:-<vac√≠o>}"

      # Subida a TestFlight (App Store Connect API Key .p8)
      - name: Upload to TestFlight
        if: steps.ipa.outputs.ipa != ''
        env:
          APPSTORE_ISSUER_ID:   ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_KEY_ID:      ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_PRIVATE_KEY: ${{ secrets.APPSTORE_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          IPA="${{ steps.ipa.outputs.ipa }}"
          mkdir -p "$HOME/.appstoreconnect/private_keys"
          KEY="$HOME/.appstoreconnect/private_keys/AuthKey_${APPSTORE_KEY_ID}.p8"
          CONTENT="${APPSTORE_PRIVATE_KEY}"
          if echo "$CONTENT" | grep -q "BEGIN PRIVATE KEY"; then
            printf '%b' "$CONTENT" > "$KEY"
          else
            if printf '%s' "$CONTENT" | base64 -d > "$KEY" 2>/dev/null; then :; else printf '%b' "$CONTENT" > "$KEY"; fi
          fi
          chmod 600 "$KEY"
          # Probar auth
          xcrun altool --list-providers --apiKey "$APPSTORE_KEY_ID" --apiIssuer "$APPSTORE_ISSUER_ID" >/dev/null
          # Subir
          xcrun altool --upload-app -f "$IPA" -t ios --apiKey "$APPSTORE_KEY_ID" --apiIssuer "$APPSTORE_ISSUER_ID" --verbose

      # Artefactos b√°sicos
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-outputs
          path: |
            ${{ steps.ipa.outputs.ipa }}
          if-no-files-found: warn
